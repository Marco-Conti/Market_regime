name: HMM Daily Report
on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:
jobs:
  send-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib scikit-learn yfinance hmmlearn
      - name: Run HMM script and capture output
        run: |
          python hmm_daily.py | tee output.log
      - name: Send PDF report and log to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Trova il file PDF generato (inizia con HMM_Report_)
          PDF_FILE=$(find . -maxdepth 1 -name "HMM_Report_*.pdf" | head -n 1)
          
          if [ -f "$PDF_FILE" ]; then
            echo "Sending PDF: $PDF_FILE"
            # Usa sendDocument per i PDF
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
              -F chat_id=${TELEGRAM_CHAT_ID} \
              -F document=@"$PDF_FILE" \
              -F caption="üìä HMM Daily Report - $(date +'%Y-%m-%d')"
          else
            echo "Error: PDF report not found!"
            # Invia notifica di errore
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -F chat_id=${TELEGRAM_CHAT_ID} \
              -F text="‚ùå Error: HMM Report generation failed. PDF not found."
          fi
