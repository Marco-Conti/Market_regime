name: HMM Daily Report

on:
  schedule:
    - cron: '0 7 * * *'  # 7:00 UTC = 9:00 Italia (ora legale)
  workflow_dispatch:     # Permette di lanciare manualmente il workflow

jobs:
  send-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib scikit-learn yfinance hmmlearn

      - name: Run HMM script
        run: python hmm_daily.py

      - name: Send results to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Invio del messaggio di testo
          TEXT=$(cat message.txt)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d parse_mode=Markdown \
            -d text="$(echo "$TEXT" | tr -d '\000-\037')"

          # Invio del grafico principale
          if [ -f "hmm_plot.png" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto" \
              -F chat_id=${TELEGRAM_CHAT_ID} \
              -F photo=@"hmm_plot.png"
          else
            echo "⚠️ File hmm_plot.png non trovato"
          fi
