name: HMM Daily Report
on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:
jobs:
  send-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib scikit-learn yfinance hmmlearn
      - name: Run HMM script and capture output
        run: |
          python hmm_daily.py | tee output.log
      - name: Send plot to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Leggi le date dal file
          if [ -f "report_info.txt" ]; then
            source report_info.txt
            CAPTION="üìä HMM Daily Report
üìÖ Report generato: ${REPORT_DATE}
üìà Ultima osservazione: ${LAST_DATA_DATE}"
          else
            CAPTION="üìä HMM Daily Report - $(date '+%Y-%m-%d %H:%M:%S')"
          fi
          
          # Invio grafico
          if [ -f "hmm_plot.png" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto" \
              -F chat_id=${TELEGRAM_CHAT_ID} \
              -F photo=@"hmm_plot.png" \
              -F caption="$CAPTION"
          else
            echo "‚ö†Ô∏è hmm_plot.png not found"
          fi
